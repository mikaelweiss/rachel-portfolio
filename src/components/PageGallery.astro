---
interface Props {
	pagesDir: string;
	pageCount: number;
	alt: string;
}

const { pagesDir, pageCount, alt } = Astro.props;

function pagePath(dir: string, page: number, total: number): string {
	const padded = total >= 10;
	const num = padded ? String(page).padStart(2, '0') : String(page);
	return `${dir}/page-${num}.jpg`;
}

const pages = Array.from({ length: pageCount }, (_, i) => ({
	src: pagePath(pagesDir, i + 1, pageCount),
	alt: `${alt} - page ${i + 1}`,
}));
---

<div class="page-gallery">
	<p class="page-count">{pageCount} {pageCount === 1 ? 'page' : 'pages'}</p>
	<div class="grid">
		{pages.map((page) => (
			<a href={page.src} class="glightbox thumb" data-gallery="pages">
				<img src={page.src} alt={page.alt} loading="lazy" />
				<span class="expand-icon" aria-hidden="true">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256" fill="currentColor"><path d="M216,48V96a8,8,0,0,1-16,0V67.31l-50.34,50.35a8,8,0,0,1-11.32-11.32L188.69,56H160a8,8,0,0,1,0-16h48A8,8,0,0,1,216,48ZM106.34,138.34,56,188.69V160a8,8,0,0,0-16,0v48a8,8,0,0,0,8,8H96a8,8,0,0,0,0-16H67.31l50.35-50.34a8,8,0,0,0-11.32-11.32Z"/></svg>
				</span>
			</a>
		))}
	</div>
</div>

<script>
	import GLightbox from 'glightbox';
	import 'glightbox/dist/css/glightbox.min.css';

	document.addEventListener('astro:page-load', () => {
		GLightbox({
			selector: '.glightbox',
			touchNavigation: true,
			loop: false,
		});
	});

	GLightbox({
		selector: '.glightbox',
		touchNavigation: true,
		loop: false,
	});
</script>

<style>
	.page-gallery {
		max-width: 65ch;
		margin-inline: auto;
	}

	.page-count {
		text-align: center;
		color: var(--gray-300);
		font-size: var(--text-sm);
		margin-bottom: 1rem;
	}

	.grid {
		columns: 2;
		gap: 0.75rem;
	}

	.thumb {
		display: block;
		position: relative;
		break-inside: avoid;
		margin-bottom: 0.75rem;
		cursor: zoom-in;
		border-radius: 0.75rem;
		overflow: hidden;
	}

	.thumb img {
		width: 100%;
		height: auto;
		display: block;
		transition: filter 0.2s ease;
	}

	.expand-icon {
		position: absolute;
		bottom: 0.5rem;
		right: 0.5rem;
		background: rgba(0, 0, 0, 0.5);
		color: white;
		border-radius: 0.375rem;
		padding: 0.25rem;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: opacity 0.2s ease, background 0.2s ease;
	}

	/* Mobile: persistent subtle icon */
	@media (hover: none) {
		.expand-icon {
			opacity: 0.6;
		}
	}

	/* Desktop: hidden by default, visible on hover with darkened image */
	@media (hover: hover) {
		.expand-icon {
			opacity: 0;
		}

		.thumb:hover img {
			filter: brightness(0.75);
		}

		.thumb:hover .expand-icon {
			opacity: 1;
		}
	}

	@media (min-width: 50em) {
		.grid {
			columns: 3;
			gap: 1rem;
		}

		.thumb {
			margin-bottom: 1rem;
		}
	}
</style>
